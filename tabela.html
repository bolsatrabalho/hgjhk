<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de FrequÃªncia de Bolsistas</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    padding: 20px;
}
.container {
    background: #fff;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
th, td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
}
th {
    background: #f0f0f0;
}
button {
    padding: 6px 10px;
    border: none;
    border-radius: 4px;
    background: #0057b8;
    color: #fff;
    cursor: pointer;
}
button:hover {
    background: #004494;
}
.hidden {
    display: none;
}
select, input[type="text"], input[type="date"], input[type="file"] {
    width: 100%;
    font-size: 12px;
}
.info {
    margin-bottom: 15px;
    font-weight: bold;
}
</style>
</head>
<body>
<div class="container">

<h2>Sistema de FrequÃªncia de Bolsistas</h2>
<div class="info" id="infoUsuario"></div>

<div style="margin:10px 0;">
    <button id="btnAdicionar" onclick="adicionarBolsista()">âž• Adicionar Bolsista</button>
    <button onclick="salvar()">ðŸ’¾ Salvar</button>
    <button onclick="enviarPlanilha()">ðŸ“¤ Enviar Planilha</button>
</div>

<table>
<thead>
<tr>
    <th>Campus</th>
    <th>Nome</th>
    <th>MatrÃ­cula</th>
    <th>Setor</th>
    <th>InÃ­cio</th>
    <th>Fim</th>
    <th>Email Coordenador</th>
    <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th>
    <th>Mai</th><th>Jun</th><th>Jul</th><th>Ago</th>
    <th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
    <th>Justificativa</th>
    <th>Arquivo</th>
    <th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const URL_APPS = "https://script.google.com/macros/s/AKfycbx39QEb6jGtcnNlGdoiSmG3hQty8kFjwW0NO_R_xuixW2w4BEIynelJro7E6otNEzHmGQ/exec"; // substitua pelo seu Web App

const emailUsuario = sessionStorage.getItem("coordenadorLogado");
const EMAIL_ADMIN = "bolsatrabalho@prex.uespi.br";
const tipoUsuario = emailUsuario === EMAIL_ADMIN ? "admin" : "coordenador";

if(!emailUsuario){
    alert("Acesso invÃ¡lido.");
    window.location.href="index.html";
}

document.getElementById("infoUsuario").innerText = `UsuÃ¡rio: ${emailUsuario} | Perfil: ${tipoUsuario}`;

if(tipoUsuario !== "admin"){
    document.getElementById("btnAdicionar").classList.add("hidden");
}

// Dados
let bolsistas = JSON.parse(localStorage.getItem("bolsistas")) || [];

// Render tabela
function renderTabela(){
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    bolsistas.forEach((b,i)=>{
        if(tipoUsuario !== "admin" && b.coordenador !== emailUsuario) return;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${campoTexto(b.campus,i,"campus",tipoUsuario==="admin")}</td>
            <td>${campoTexto(b.nome,i,"nome",tipoUsuario==="admin")}</td>
            <td>${campoTexto(b.matricula,i,"matricula",tipoUsuario==="admin")}</td>
            <td>${campoTexto(b.setor,i,"setor",tipoUsuario==="admin")}</td>
            <td>${campoData(b.inicio,i,"inicio",tipoUsuario==="admin")}</td>
            <td>${campoData(b.fim,i,"fim",tipoUsuario==="admin")}</td>
            <td>${campoTexto(b.coordenador,i,"coordenador",tipoUsuario==="admin")}</td>
            ${mesesHTML(b,i)}
            <td>${campoTexto(b.justificativa,i,"justificativa",true)}</td>
            <td><input type="file" onchange="uploadArquivo(event,${i})"></td>
            <td>${tipoUsuario==="admin"?`<button onclick="removerBolsista(${i})">Remover</button>`:""}</td>
        `;
        tbody.appendChild(tr);
    });
    salvar(false);
}

function campoTexto(valor,i,campo,editavel){
    return editavel ? `<input type="text" value="${valor||''}" onchange="bolsistas[${i}]['${campo}']=this.value">` : valor||'';
}
function campoData(valor,i,campo,editavel){
    return editavel ? `<input type="date" value="${valor||''}" onchange="bolsistas[${i}]['${campo}']=this.value">` : valor||'';
}
const MESES = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
function mesesHTML(b,i){
    return MESES.map(m=>{
        const val = b[m]||"";
        return `<td>
            <select onchange="bolsistas[${i}]['${m}']=this.value">
                <option value=""></option>
                <option value="SIM" ${val==="SIM"?"selected":""}>SIM</option>
                <option value="NÃƒO" ${val==="NÃƒO"?"selected":""}>NÃƒO</option>
            </select>
        </td>`;
    }).join("");
}

// FunÃ§Ãµes
function adicionarBolsista(){
    bolsistas.push({campus:"",nome:"",matricula:"",setor:"",inicio:"",fim:"",coordenador:"",justificativa:""});
    renderTabela();
}

function removerBolsista(i){
    if(confirm("Remover bolsista?")){ bolsistas.splice(i,1); renderTabela();}
}

function salvar(msg=true){
    localStorage.setItem("bolsistas",JSON.stringify(bolsistas));
    if(msg) alert("Salvo com sucesso!");
}

function uploadArquivo(e,i){
    const file = e.target.files[0];
    if(!file) return;
    if(file.size > 10*1024*1024){ alert("Arquivo maior que 10MB"); e.target.value=""; return;}
    const reader = new FileReader();
    reader.onload=()=>{ 
        bolsistas[i].arquivoBase64 = reader.result.split(",")[1];
        bolsistas[i].arquivoNome = file.name;
        bolsistas[i].arquivoMime = file.type;
    };
    reader.readAsDataURL(file);
}

function enviarPlanilha(){
    fetch(URL_APPS,{
        method:"POST",
        body: JSON.stringify(bolsistas)
    }).then(r=>r.json())
    .then(d=>{
        if(d.status==="ok") alert("Dados enviados com sucesso!");
        else alert("Erro: "+d.mensagem);
    })
    .catch(err=>alert("Erro de conexÃ£o!"));
}

// Init
renderTabela();
</script>
</body>
</html>
